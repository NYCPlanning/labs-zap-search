<div class="cell large-6 xlarge-7 xxlarge-5 xxlarge-offset-1">

  {{#projects-map-data as |projects|}}
    {{#if fetchData.lastSuccessful}}
      {{!-- High-level dynamic tiles configuration --}}
      {{#projects.dynamic-tiles
        tiles=tiles
        layer=(hash
          id='project-centroids-circle'
          type='circle'
          source='project-centroids'
          source-layer='project-centroids'
          paint=(hash
            circle-radius=(hash
              stops=(array (array 10 3) (array 15 4))
            )
            circle-color=(hash
              property='dcp_publicstatus_simp'
              type='categorical'
              stops=(array
                (array 'Filed' '#FF9400')
                (array 'In Public Review' '#78D271')
                (array 'Complete' '#44A3D5')
              )
              default='#6b717b'
            )
            circle-opacity = 1
            circle-stroke-width = (hash stops = (array (array 10 1) (array 15 2)) )
            circle-stroke-color = '#FFFFFF'
          )
        )
      }}
        {{!-- Anything else for dynamic tiles, like hovers --}}
        {{projects.map.layer
          layer=(hash
            id='project-centroids-circle-hover'
            type='circle'
            source='project-centroids'
            source-layer='project-centroids'
            layout=(hash visibility='none')
            paint=(hash
              circle-radius=5
              circle-color='#ae561f'
              circle-opacity = 1
              circle-stroke-width = (hash stops = (array (array 10 1) (array 15 2)) )
              circle-stroke-color = '#FFFFFF'
            )
          )
        }}
      {{/projects.dynamic-tiles}}

      {{projects.map.call 'fitBounds' fetchData.lastSuccessful.value.meta.bounds (hash padding=20)}}
    {{/if}}
  {{/projects-map-data}}

  <div class="project-filters">
    {{#filter-section
      filterTitle='Date Certified / Referred'
      appliedFilters=applied-filters
      filterNames='dcp_certifiedreferred'
      mutateArray=(action 'mutateArray')
      as |section|
    }}
      {{slider-filter
        start=dcp_certifiedreferred
        min=(object-at 0 queryParamsState.dcp_certifiedreferred.defaultValue)
        max=(object-at 1 queryParamsState.dcp_certifiedreferred.defaultValue)
        replaceProperty=(action section.delegate-mutation (action (mut dcp_certifiedreferred)))}}
    {{/filter-section}}

    {{#filter-section
      filterTitle='Project Name / Description / Applicant'
      appliedFilters=applied-filters
      filterNames='project_applicant_text'
      mutateArray=(action 'mutateArray')
      as |section|
    }}
       <input
        class="filter-text-input"
        type="text"
        value={{project_applicant_text}}
        oninput={{action section.delegate-mutation (action 'setDebouncedText' 'project_applicant_text')}}>
    {{/filter-section}}

    {{#filter-section
      filterTitle='ULURP / CEQR Number'
      appliedFilters=applied-filters
      filterNames='ulurp_ceqr_text'
      mutateArray=(action 'mutateArray')
      as |section|
    }}
       <input
        class="filter-text-input"
        type="text"
        value={{ulurp_ceqr_text}}
        oninput={{action section.delegate-mutation (action 'setDebouncedText' 'ulurp_ceqr_text')}}>
    {{/filter-section}}

    {{#filter-section
      filterTitle='Project Stage'
      appliedFilters=applied-filters
      filterNames='dcp_publicstatus'
      mutateArray=(action 'mutateArray')
      as |section|
    }}
      <ul class="menu vertical medium-horizontal stage-checkbox">
        {{#each (array 'Filed' 'In Public Review' 'Complete' 'Unknown') as |type|}}
          <li {{action section.delegate-mutation (action 'mutateArray' 'dcp_publicstatus' type)}}>
            <a>
              {{filter-checkbox
                value=type
                currentValues=dcp_publicstatus
              }}
            </a>
          </li>
        {{/each}}
      </ul>
    {{/filter-section}}

    {{#filter-section
      filterTitle='Borough / Block'
      appliedFilters=applied-filters
      filterNames=(array 'boroughs' 'block')
      mutateArray=(action 'mutateArray')
      as |section|
    }}
      <ul class="menu vertical medium-horizontal stage-checkbox">
        {{#each (array 'Citywide' 'Manhattan' 'Bronx' 'Brooklyn' 'Queens' 'Staten Island') as |type|}}
          <li {{action section.delegate-mutation (action 'mutateArray' 'boroughs' type)}}>
            <a>
              {{filter-checkbox
                value=type
                currentValues=boroughs
              }}
            </a>
          </li>
        {{/each}}
      </ul>
      <input
        class="filter-text-input"
        type="text"
        value={{block}}
        placeholder="Block Number (e.g. '1000')"
        oninput={{action section.delegate-mutation (action 'setDebouncedText' 'block')}}>
    {{/filter-section}}

    {{#filter-section
      filterTitle='Community District'
      appliedFilters=applied-filters
      filterNames='community-districts'
      mutateArray=(action 'mutateArray')
      as |section|
    }}
      {{#power-select-multiple
        options=(lookup-community-district)
        selected=(contains-keys
          (lookup-community-district)
          community-districts
          key='code')
        placeholder="Select some names..."
        searchField='searchField'
        onchange=(action section.delegate-mutation (action 'replaceProperty' 'community-districts'))
        as |district|
      }}
        {{district.boro}} {{district.num}}
      {{/power-select-multiple}}
    {{/filter-section}}

    {{#filter-section
      filterTitle='Action Type'
      appliedFilters=applied-filters
      filterNames='action-types'
      mutateArray=(action 'mutateArray')
      as |section|
    }}
      {{#power-select-multiple
        options=(lookup-action-type)
        selected=(contains-keys
          (lookup-action-type)
          action-types
          key='code')
        placeholder="Select some actions..."
        searchField='searchField'
        onchange=(action section.delegate-mutation (action 'replaceProperty' 'action-types'))
        as |action|
      }}
        {{action.code}}

        {{#if action.short}}
          - {{action.short}}
        {{/if}}
      {{/power-select-multiple}}
    {{/filter-section}}

    {{#filter-section
      filterTitle='CEQR Type'
      appliedFilters=applied-filters
      filterNames='dcp_ceqrtype'
      mutateArray=(action 'mutateArray')
      as |section|
    }}
      <ul class="menu vertical medium-horizontal CEQR-checkbox">
        {{#each (array 'Unlisted' 'Type I' 'Type II') as |type|}}
          <li {{action section.delegate-mutation (action 'mutateArray' 'dcp_ceqrtype' type)}}>
            <a>
              {{filter-checkbox
                value=type
                currentValues=dcp_ceqrtype}}
            </a>
          </li>
        {{/each}}
      </ul>
    {{/filter-section}}

    {{#filter-section
      filterTitle='FEMA Flood Zone'
      appliedFilters=applied-filters
      filterNames=(array 'dcp_femafloodzonea' 'dcp_femafloodzoneshadedx' 'dcp_femafloodzonecoastala' 'dcp_femafloodzonev')
      mutateArray=(action 'mutateArray')
      as |section|
    }}
      <ul class="menu vertical medium-horizontal FEMA-checkbox">
        <li {{action section.delegate-mutation (action 'toggleBoolean' 'dcp_femafloodzonev')}}>
          <a>
            {{fa-icon
              (if dcp_femafloodzonev 'check-square' 'square')
              prefix=(unless dcp_femafloodzonev 'far')
              class=(if dcp_femafloodzonev 'dark-gray' 'medium-gray')
            }} V
            <sup>
              {{icon-tooltip
                tip='A portion of the 1% annual chance floodplain subject to high velocity wave action (a breaking wave 3 feet high or larger). V Zones are subject to more stringent building requirements than other zones because of the damaging force of waves.'
                class="dark-gray"
              }}
            </sup>
          </a>
        </li>
        <li {{action section.delegate-mutation (action 'toggleBoolean' 'dcp_femafloodzonecoastala')}}>
          <a>
            {{fa-icon
              (if dcp_femafloodzonecoastala 'check-square' 'square')
              prefix=(unless dcp_femafloodzonecoastala 'far')
              class=(if dcp_femafloodzonecoastala 'dark-gray' 'medium-gray')
            }} Coastal A
            <sup>
              {{icon-tooltip
                tip='A sub-zone of the A Zone where wave heights are expected to be between 1.5 and 3 feet high. This zone is indicated by the Limit of Moderate Wave Action (LiMWA) line on the latest FEMA FIRMs.'
                class="dark-gray"
              }}
            </sup>
          </a>
        </li>
        <li {{action section.delegate-mutation (action 'toggleBoolean' 'dcp_femafloodzonea')}}>
          <a>
            {{fa-icon
              (if dcp_femafloodzonea 'check-square' 'square')
              prefix=(unless dcp_femafloodzonea 'far')
              class=(if dcp_femafloodzonea 'dark-gray' 'medium-gray')
            }} A
            <sup>
              {{icon-tooltip
                tip='A portion of the area subject to flooding from the 1% annual chance flood. These areas are not subject to high velocity wave action but are still considered high risk flooding areas. In A Zones, NYC Building Code requires buildings to be elevated or flood-proofed based on the Base Flood Elevation identified on the FEMAâ€™s FIRMs.'
                class="dark-gray"
              }}
            </sup>
          </a>
        </li>
        <li {{action section.delegate-mutation (action 'toggleBoolean' 'dcp_femafloodzoneshadedx')}}>
          <a>
            {{fa-icon
              (if dcp_femafloodzoneshadedx 'check-square' 'square')
              prefix=(unless dcp_femafloodzoneshadedx 'far')
              class=(if dcp_femafloodzoneshadedx 'dark-gray' 'medium-gray')
            }} Shaded X
            <sup>
              {{icon-tooltip
                tip='The area of moderate flood risk outside the regulatory 1% annual chance flood but within the limits of the 0.2% annual chance flood level (the 500-year floodplain). There are no current NYC Building Code or FEMA flood insurance purchase requirements for buildings in this zone.'
                class="dark-gray"
              }}
            </sup>
          </a>
        </li>
      </ul>
    {{/filter-section}}

    {{#filter-section
      filterTitle='ULURP'
      appliedFilters=applied-filters
      filterNames='dcp_ulurp_nonulurp'
      mutateArray=(action 'mutateArray')
      as |section|
    }}
      <ul class="menu vertical medium-horizontal ULURP-checkbox">
        <li {{action section.delegate-mutation (action 'mutateArray' 'dcp_ulurp_nonulurp' 'ULURP')}}>
          <a>
            {{filter-checkbox
              value='ULURP'
              currentValues=dcp_ulurp_nonulurp}}
          </a>
        </li>
        <li {{action section.delegate-mutation (action 'mutateArray' 'dcp_ulurp_nonulurp' 'Non-ULURP')}}>
          <a>
            {{filter-checkbox
              value='Non-ULURP'
              currentValues=dcp_ulurp_nonulurp}}
          </a>
        </li>
      </ul>
    {{/filter-section}}

    <div class="filter">
      <p class="text-center no-margin">
        <span
          class="button projects-reset-filters-button small gray text-orange no-margin"
          onClick={{action 'resetAll'}}>
          &nbsp;RESET&nbsp;FILTERS&nbsp;
        </span>
      </p>
    </div>
  </div>
</div>
<div class="cell large-6 xlarge-5 xxlarge-6">
  <div class="results">
    <h3 class="results-header header-medium">
      {{numeral-format fetchData.lastSuccessful.value.meta.total '0,0'}}
      application{{unless (eq fetchData.lastSuccessful.value.meta.total 1) 's'}}
      {{if (eq fetchData.lastSuccessful.value.meta.total 1) 'matches' 'match'}} your filters
      <span class="float-right results-header-count">
        {{#if fetchData.isRunning}}
          {{fa-icon 'spinner' class="fa-spin medium-gray"}}
        {{else}}
           listing 1-{{numeral-format cachedProjects.length '0,0'}}
        {{/if}}
        &nbsp;<span class="medium-gray">|</span>&nbsp;
        {{#tool-tipster
          content='Download all applications that match your filters'
          tagName='span'
        }}
          <a href={{downloadURL}} >{{fa-icon 'download'}} <small>(CSV)</small></a>
        {{/tool-tipster}}
      </span>
    </h3>
    <ul class="results-list no-bullet">
      {{#each cachedProjects as |project|}}
        {{project-list-item project=project}}
      {{/each}}
    </ul>

    <p class="text-center" style="margin:3rem 0 6rem;">
      <span
        class="button projects-load-more-button gray text-orange"
        onClick={{unless noMoreRecords (queue (action (mut page) (add page 1)) (perform fetchData))}}
        disabled={{or noMoreRecords fetchData.isRunning}}
      >
        {{#if fetchData.isRunning}}
          {{fa-icon 'spinner' class="fa-spin" transform='grow-8'}}
        {{else}}
          LOAD MORE
        {{/if}}
      </span>
    </p>
  </div>
</div>

{{outlet}}
